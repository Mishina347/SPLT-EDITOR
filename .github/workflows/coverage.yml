name: Coverage Report

on:
 push:
  branches: [main]
 pull_request:
  branches: [main]

jobs:
 coverage:
  runs-on: ubuntu-latest

  steps:
   - name: Checkout code
     uses: actions/checkout@v4

   - name: Setup Node.js
     uses: actions/setup-node@v4
     with:
      node-version: 20
      cache: 'npm'

   - name: Install dependencies
     run: npm ci

   - name: Run tests with coverage
     run: npm run test:coverage

   - name: Generate coverage badge
     uses: codecov/codecov-action@v4
     with:
      file: ./coverage/lcov.info
      flags: unittests
      name: codecov-umbrella
      fail_ci_if_error: false

   - name: Comment coverage on PR
     if: github.event_name == 'pull_request'
     uses: actions/github-script@v7
     with:
      script: |
       const fs = require('fs');

       try {
         const coverage = JSON.parse(fs.readFileSync('./coverage/coverage-summary.json', 'utf8'));
         const total = coverage.total;
         
         const coverageComment = `
         ## ğŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ
         
         | é …ç›® | ã‚«ãƒãƒ¬ãƒƒã‚¸ | è©³ç´° |
         |------|-----------|------|
         | **Statements** | ${total.statements.pct}% | ${total.statements.covered}/${total.statements.total} |
         | **Branches** | ${total.branches.pct}% | ${total.branches.covered}/${total.branches.total} |
         | **Functions** | ${total.functions.pct}% | ${total.functions.covered}/${total.functions.total} |
         | **Lines** | ${total.lines.pct}% | ${total.lines.covered}/${total.lines.total} |
         
         ${total.lines.pct >= 80 ? 'âœ…' : total.lines.pct >= 60 ? 'âš ï¸' : 'âŒ'} **Overall Coverage: ${total.lines.pct}%**
         
         ---
         *ã“ã®è¦†ç›–ç‡æŠ¥å‘Šã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
         `;
         
         github.rest.issues.createComment({
           issue_number: context.issue.number,
           owner: context.repo.owner,
           repo: context.repo.repo,
           body: coverageComment
         });
       } catch (error) {
         console.log('Coverage summary not found or invalid');
       }
